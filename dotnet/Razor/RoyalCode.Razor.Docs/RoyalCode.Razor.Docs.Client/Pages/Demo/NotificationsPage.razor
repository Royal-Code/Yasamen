@page "/notifications"
@using RoyalCode.Razor.Internal.Notifications

@layout AppMainLayout

<Box AdditionalClasses="p-8 bg-white border-none">

    <h1>Notifications</h1>

    <div class="flex gap-6 items-center mb-6">
        <label class="flex items-center gap-2">
            <input type="checkbox" @bind="showIcon" @bind:after="StateHasChanged" />
            <span>Ícone</span>
        </label>
        <label class="flex items-center gap-2">
            <input type="checkbox" @bind="closeable" @bind:after="StateHasChanged" />
            <span>Closeable</span>
        </label>
        <label class="flex items-center gap-2">
            <input type="checkbox" @bind="closeOnClick" @bind:after="StateHasChanged" />
            <span>CloseOnClick</span>
        </label>
        <button class="ya-btn ya-btn-primary" type="button" @onclick="ReopenAll">Reabrir todos</button>
    </div>

    <h2>Notificações por estilo</h2>

    <div class="w-full">
        @for (var i = 0; i < _items.Count; i++)
        {
            var item = _items[i];
            <div class="flex items-center gap-4 mb-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" @bind="item.ShowTimer" @bind:after="(() => StateHasChanged())" />
                    <span>Timer</span>
                </label>
                <input type="number"
                       min="0"
                       step="1"
                       style="width: 6rem;"
                       @bind-value="item.TimerSeconds"
                       @bind-value:event="oninput"
                       @bind-value:after="StateHasChanged" />

                <Notification @ref="item.Ref"
                              Style="@item.Theme"
                              Text="Notificação de exemplo"
                              Icon="@showIcon"
                              Closeable="@closeable"
                              CloseOnClick="@closeOnClick"
                              Timer="@(item.ShowTimer && item.TimerSeconds > 0 ? TimeSpan.FromSeconds(item.TimerSeconds) : null)"
                              AdditionalClasses="flex-1" />
            </div>
        }
    </div>

    <h2>Notificações com NotificationContent</h2>

    <Notification Icon="@showIcon"
                  Closeable="@closeable"
                  CloseOnClick="@closeOnClick">
        <NotificationContent Text="Notificação com conteúdo personalizado"
							 Details="Este é um exemplo de notificação que utiliza o componente NotificationContent para exibir texto e detalhes de forma estruturada." />
    </Notification>

    <h2 class="mt-8">Notificações em Grupos</h2>

    <div class="flex gap-6 items-center mb-6">
        <label class="flex items-center gap-2">
            <span>Placement</span>
            <select class="ya-input" @bind="selectedPlacement">
                @foreach (var p in _placements)
                {
                    <option value="@p">@p</option>
                }
            </select>
        </label>
        <label class="flex items-center gap-2">
            <input type="checkbox" @bind="useContent" />
            <span>Usar NotificationContent</span>
        </label>
        <button class="ya-btn ya-btn-primary" type="button" @onclick="AddToGroup">Adicionar notificação</button>
    </div>

    <NotificationGroup Placement="@selectedPlacement">
        @foreach (var n in _groupItems)
        {
            if (useContent)
            {
                <Notification Icon="true"
                              Closeable="true"
                              Timer="@TimeSpan.FromSeconds(8)"
                              OnClose="(() => RemoveFromGroup(n.Id))">
                    <NotificationContent Text="@n.Text" Details="@n.Details" />
                </Notification>
            }
            else
            {
                <Notification Text="@n.Text"
                              Icon="true"
                              Closeable="true"
                              Timer="@TimeSpan.FromSeconds(8)"
                              OnClose="(() => RemoveFromGroup(n.Id))" />
            }
        }
    </NotificationGroup>

    <h2 class="mt-8">Notificações em Grupos com Animation</h2>

    <div class="flex gap-6 items-center mb-6">
        <label class="flex items-center gap-2">
            <span>Placement</span>
            <select class="ya-input" @bind="selectedPlacement2">
                @foreach (var p in _placements)
                {
                    <option value="@p">@p</option>
                }
            </select>
        </label>
        <label class="flex items-center gap-2">
            <input type="checkbox" @bind="useContent2" />
            <span>Usar NotificationContent</span>
        </label>
        <button class="ya-btn ya-btn-primary" type="button" @onclick="AddToGroup2">Adicionar notificação</button>
    </div>

    <NotificationGroup Placement="@selectedPlacement2">
        @foreach (var n in _groupItems2)
        {
            <NotificationAnimation @ref="n.AnimRef">
                @if (useContent2)
                {
                    <Notification Icon="true"
                                  Closeable="true"
                                  Timer="@TimeSpan.FromSeconds(8)"
                                  OnClose="@(async () => { if (n.AnimRef is not null) await n.AnimRef.CloseAsync(); RemoveFromGroup2(n.Id); })">
                        <NotificationContent Text="@n.Text" Details="@n.Details" />
                    </Notification>
                }
                else
                {
                    <Notification Text="@n.Text"
                                  Icon="true"
                                  Closeable="true"
                                  Timer="@TimeSpan.FromSeconds(8)"
                                  OnClose="@(async () => { if (n.AnimRef is not null) await n.AnimRef.CloseAsync(); RemoveFromGroup2(n.Id); })" />
                }
            </NotificationAnimation>
        }
    </NotificationGroup>

</Box>

@code {
    private bool showIcon = true;
    private bool closeable = false;
    private bool closeOnClick = true;

    private readonly Themes[] _themes =
    [
        Themes.Primary,
        Themes.Secondary,
        Themes.Tertiary,
        Themes.Info,
        Themes.Highlight,
        Themes.Success,
        Themes.Warning,
        Themes.Alert,
        Themes.Danger,
        Themes.Light,
        Themes.Dark
    ];

    private readonly List<Item> _items = new();
    private readonly Placements[] _placements = Enum.GetValues<Placements>();
    private Placements selectedPlacement = Placements.TopEnd;
    private bool useContent = true;
    private readonly List<GroupItem> _groupItems = new();
    private Placements selectedPlacement2 = Placements.TopEnd;
    private bool useContent2 = true;
    private readonly List<GroupItem> _groupItems2 = new();

    protected override void OnInitialized()
    {
        foreach (var theme in _themes)
        {
            _items.Add(new Item { Theme = theme });
        }
    }

    private void AddToGroup2()
    {
        _groupItems2.Add(new GroupItem
        {
            Id = Guid.NewGuid(),
            Text = "Notificação de grupo (anim)",
            Details = "Detalhes da notificação do grupo (anim)",
            PendingOpen = true,
        });
    }

    private void RemoveFromGroup2(Guid id)
    {
        var idx = _groupItems2.FindIndex(g => g.Id == id);
        if (idx >= 0)
        {
            _groupItems2.RemoveAt(idx);
            StateHasChanged();
        }
    }

    private async Task ReopenAll()
    {
        foreach (var item in _items)
        {
            if (item.Ref is not null)
            {
                await item.Ref.OpenAsync();
            }
        }
    }

    public class Item
    {
        public Themes Theme { get; set; }
        public Notification? Ref { get; set; }
        public bool ShowTimer { get; set; }
        public int TimerSeconds { get; set; } = 0;
    }

    private void AddToGroup()
    {
        _groupItems.Add(new GroupItem
        {
            Id = Guid.NewGuid(),
            Text = "Notificação de grupo",
            Details = "Detalhes da notificação do grupo",
        });
    }

    private void RemoveFromGroup(Guid id)
    {
        var idx = _groupItems.FindIndex(g => g.Id == id);
        if (idx >= 0)
        {
            _groupItems.RemoveAt(idx);
            StateHasChanged();
        }
    }

    public class GroupItem
    {
        public Guid Id { get; set; }
        public string Text { get; set; } = string.Empty;
        public string Details { get; set; } = string.Empty;
        public NotificationAnimation? AnimRef { get; set; }
        public bool PendingOpen { get; set; }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // Open animations for newly added items once their refs are available
        foreach (var item in _groupItems2)
        {
            if (item.PendingOpen && item.AnimRef is not null)
            {
                await item.AnimRef.OpenAsync();
                item.PendingOpen = false;
            }
        }
    }
}
