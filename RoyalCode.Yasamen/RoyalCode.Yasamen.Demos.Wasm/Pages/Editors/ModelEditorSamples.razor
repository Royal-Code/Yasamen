@page "/form"

<AppPageContent Title="Text Field Editor Samples">
    <ModelEditor Model="model" Context="dto" Support="support">

        <ModelSupport TModel="DistributionCenter" Context="dc" FilterSupport="dc-number">

            <TextField @bind-Value="dc.Number" Label="Number" ChangeSupport="dc-number" />
            <TextField @bind-Value="dc.Name" Label="Disctribution Center" readonly />

        </ModelSupport>

        <PropertySupport TValue="WarehouseNumbers" Name="wh-numbers" ChangeSupport="wh-numbers" />

        <ModelSupport TModel="Warehouse" Context="wh" FilterSupport="wh-numbers">

            <TextField @bind-Value="wh.Number" Label="Number" ChangeSupport="wh-number" />
            <TextField @bind-Value="wh.Description" Label="Warehouse" readonly />

        </ModelSupport>

        <PropertySupport TValue="AreaNumbers" Name="area-numbers" ChangeSupport="area-numbers" />

        <ModelKeySupport TModel="Area" TKey="Guid" KeySelect="m => m.Id" @bind-Key="dto.AreaId"
                         Context="area" FilterSupport="area-numbers">

            <TextField @bind-Value="area.Number" Label="Number" ChangeSupport="area-number" />
            <TextField @bind-Value="area.Name" Label="Area" readonly />

        </ModelKeySupport>

    </ModelEditor>
</AppPageContent>

@code {

    private WarehouseDto model;
    private PropertyChangeSupport support;

    protected override void OnInitialized()
    {
        Tracer.Write("ModelEditorSamples", "OnInitialized", "Begin");

        model = new();

        support = new();

        support.Property<WarehouseNumbers>("wh-numbers")
            .ChangeSupport<string>("dc-number", (_, number) => new WarehouseNumbers(number))
            .ChangeSupport<string>("wh-number", (property, number) => new WarehouseNumbers(property.DistributionCenterNumber, number));

        support.Property<AreaNumbers>("area-numbers")
            .ChangeSupport<WarehouseNumbers>("wh-numbers", (_, wh) => new AreaNumbers(wh))
            .ChangeSupport<string>("area-number", (an, n) => new AreaNumbers(an, n));

        support.GetChangeSupport("dc")
            .Include<DistributionCenter, Guid>("dc-id", dc => dc.Id);

        support.GetChangeSupport("wh")
            .Include<Warehouse, Guid>("wh-id", wh => wh.Id);

        Tracer.Write("ModelEditorSamples", "OnInitialized", "End");
    }

    protected override void OnAfterRender(bool firstRender)
    {
        Tracer.Write("ModelEditorSamples", "OnAfterRender", $"Begin, first: {firstRender}");
    }

}